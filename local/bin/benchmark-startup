#!/bin/bash

# ============================================================================
# SHELL STARTUP PERFORMANCE BENCHMARK - FASE 5
# ============================================================================
# Mide el tiempo de inicio del shell con y sin optimizaciones

set -e

CONFIG_DIR="${1:-.}"
ITERATIONS="${2:-5}"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============================================================================
# FUNCIONES AUXILIARES
# ============================================================================

run_benchmark() {
    local label="$1"
    local script="$2"
    local times=()
    
    echo -e "${CYAN}Running: $label${NC} (${ITERATIONS} iterations)..."
    
    for ((i=1; i<=ITERATIONS; i++)); do
        # Medir tiempo en milisegundos
        local start=$(date +%s%N)
        bash -c "$script" > /dev/null 2>&1
        local end=$(date +%s%N)
        
        # Convertir a milisegundos
        local elapsed=$(( (end - start) / 1000000 ))
        times+=($elapsed)
        
        printf "\r  Progress: $i/$ITERATIONS completed ($elapsed ms)"
    done
    
    echo ""
    
    # Calcular estadísticas
    local total=0
    for time in "${times[@]}"; do
        total=$((total + time))
    done
    
    local average=$((total / ITERATIONS))
    
    # Encontrar min y max
    local min=${times[0]}
    local max=${times[0]}
    for time in "${times[@]}"; do
        [[ $time -lt $min ]] && min=$time
        [[ $time -gt $max ]] && max=$time
    done
    
    echo -e "  ${GREEN}✓ Average: ${average}ms${NC}"
    echo -e "    Min: ${min}ms | Max: ${max}ms | Range: $((max-min))ms"
    echo ""
}

# ============================================================================
# BENCHMARKS
# ============================================================================

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}SHELL STARTUP PERFORMANCE BENCHMARK${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# BENCHMARK 1: Sourcing lib.sh sola
run_benchmark "lib.sh only" \
    "source '$CONFIG_DIR/lib.sh'"

# BENCHMARK 2: Sourcing lib.sh + functions (lazy loading header)
run_benchmark "lib.sh + functions (with lazy loading)" \
    "source '$CONFIG_DIR/lib.sh' && source '$CONFIG_DIR/functions'"

# BENCHMARK 3: Sourcing lib.sh + functions + exports
run_benchmark "lib.sh + functions + exports (optimized PATH)" \
    "source '$CONFIG_DIR/lib.sh' && source '$CONFIG_DIR/functions' && source '$CONFIG_DIR/exports'"

# BENCHMARK 4: Sourcing lib.sh + functions + exports + aliases
run_benchmark "lib.sh + functions + exports + aliases (FULL)" \
    "source '$CONFIG_DIR/lib.sh' && source '$CONFIG_DIR/functions' && source '$CONFIG_DIR/exports' && source '$CONFIG_DIR/aliases'"

# BENCHMARK 5: functions-heavy (should only be loaded on-demand)
run_benchmark "functions-heavy (on-demand only)" \
    "source '$CONFIG_DIR/lib.sh' && source '$CONFIG_DIR/functions-heavy'"

# ============================================================================
# ANÁLISIS COMPARATIVO
# ============================================================================

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}PERFORMANCE ANALYSIS${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${MAGENTA}File Sizes (Impact on Parsing):${NC}"
echo -n "  lib.sh: "
wc -l < "$CONFIG_DIR/lib.sh" | tr -d '\n'
echo -n " lines, "
du -h "$CONFIG_DIR/lib.sh" | awk '{print $1}'

echo -n "  functions: "
wc -l < "$CONFIG_DIR/functions" | tr -d '\n'
echo -n " lines, "
du -h "$CONFIG_DIR/functions" | awk '{print $1}'

echo -n "  functions-heavy: "
wc -l < "$CONFIG_DIR/functions-heavy" | tr -d '\n'
echo -n " lines, "
du -h "$CONFIG_DIR/functions-heavy" | awk '{print $1}'

echo ""
echo -e "${MAGENTA}Lazy Loading Impact:${NC}"

# Contar funciones ligeras vs pesadas
LIGHT_COUNT=$(grep -c "^function\|^[a-z_-]*()$" "$CONFIG_DIR/functions" || echo 0)
HEAVY_COUNT=$(grep -c "^function\|^[a-z_-]*()$" "$CONFIG_DIR/functions-heavy" || echo 0)
LAZY_DECL=$(grep -c "lazy_load_function" "$CONFIG_DIR/functions" || echo 0)

echo "  Light functions loaded at startup: $LIGHT_COUNT"
echo "  Heavy functions loaded on-demand: $HEAVY_COUNT"
echo "  Lazy loading declarations: $LAZY_DECL"

echo ""
echo -e "${MAGENTA}Optimization Summary:${NC}"
echo "  ✓ Lazy loading reduces startup by eliminating heavy function parsing"
echo "  ✓ PATH deduplication removes redundant directory lookups"
echo "  ✓ Command caching via is_command_available() speeds up checks"
echo "  ✓ Conditional exports loading only loads available tools"

echo ""
echo -e "${GREEN}✓ Benchmark complete!${NC}"
echo ""
echo -e "${CYAN}Interpretation:${NC}"
echo "  • Should see <100ms for lib.sh alone"
echo "  • Should see <150ms for lib.sh + functions"
echo "  • Should see <250ms for full config (with caching optimizations)"
echo "  • functions-heavy should only load on first use of heavy function"
