#!/usr/bin/env python3
"""
Script para descargar videos con yt-dlp desde WSL2
Los videos se guardan en la carpeta de Descargas de Windows
"""

import subprocess
import os
import sys

def get_windows_downloads_path():
    """Obtiene la ruta de la carpeta de Descargas de Windows desde WSL2"""
    try:
        # Obtiene el nombre de usuario de Windows con codificación correcta
        result = subprocess.run(
            ['cmd.exe', '/c', 'echo', '%USERNAME%'],
            capture_output=True,
            encoding='cp850'  # Codificación de Windows en español
        )
        username = result.stdout.strip()
        
        # Construye la ruta a la carpeta de Descargas
        downloads_path = f"/mnt/c/Users/{username}/Downloads"
        
        # Verifica que la carpeta existe
        if os.path.exists(downloads_path):
            return downloads_path
        else:
            print(f"Error: No se encontró la carpeta {downloads_path}")
            return None
    except Exception as e:
        print(f"Error al obtener la ruta de Windows: {e}")
        return None

def download_video(url, output_path):
    """Descarga un video usando yt-dlp"""
    try:
        # Comando yt-dlp con opciones para máxima calidad
        cmd = [
            'yt-dlp',
            '-f', 'bestvideo+bestaudio/best',  # Mejor video + mejor audio disponible
            '--merge-output-format', 'mp4',     # Combina en MP4
            '--no-warnings',                    # Oculta warnings
            '--no-check-certificates',          # Evita problemas de certificados
            '--extractor-args', 'youtube:player_client=android',  # Usa cliente Android (más estable)
            '-o', f'{output_path}/%(title)s.%(ext)s',
            url
        ]
        
        print(f"Descargando: {url}")
        print(f"Guardando en: {output_path}")
        print("-" * 50)
        
        # Ejecuta el comando
        subprocess.run(cmd, check=True)
        
        print("\n¡Descarga completada!")
        return True
        
    except subprocess.CalledProcessError as e:
        print(f"\nError al descargar el video: {e}")
        return False
    except FileNotFoundError:
        print("\nError: yt-dlp no está instalado.")
        print("Instálalo con: pip install yt-dlp")
        return False

def main():
    # Verifica argumentos
    if len(sys.argv) < 2:
        print("Uso: python3 descargar_video.py <URL>")
        print("Ejemplo: python3 descargar_video.py https://www.youtube.com/watch?v=...")
        sys.exit(1)
    
    url = sys.argv[1]
    
    # Obtiene la ruta de Descargas de Windows
    downloads_path = get_windows_downloads_path()
    
    if not downloads_path:
        print("No se pudo determinar la carpeta de Descargas de Windows")
        sys.exit(1)
    
    # Descarga el video
    success = download_video(url, downloads_path)
    
    if success:
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()
